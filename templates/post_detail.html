{% extends "base.html" %}

{% block title %}My post{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ post.title }}</h1>
    <p class="meta">
        Event Date: {{ post.event_datetime }} | {{ post.location }}
    </p>

    <p class="meta"> 
        Posted on: {{ post.local_date_posted_value.strftime('%Y-%m-%d %H:%M') if post.local_date_posted_value else '' }} by {{ post.user.name }}
    </p>

    <div class="content">
        <p>{{ post.content }}</p>
    </div>
    
    <p>Status: {{ post.post_status }}</p>
    <p>Required Participants: {{ post.participants }}</p>

    <!-- Join activity request -->
    {% if current_user.is_authenticated and current_user.user_email != post.user_email and post.post_status == "open" %}
        <form action="{{ url_for('activityrequest', post_id=post.post_id) }}" method="post">
            <button type="submit" class="btn btn-primary">Request to Join</button>
        </form>
    {% endif %}

    <!-- Show join requests (only to post owner) -->
    {% if current_user.is_authenticated and current_user.user_email == post.user_email %}
        <hr>
        <h3>Join Requests</h3>
        {% if join_requests %}
            <ul>
                {% for req in join_requests %}
                    <li>
                        {{ req.user.name }} ({{ req.user.user_email }}) - Status: {{ req.status }}

                        {% if req.status == "pending" %}
                            <!-- Accept button -->
                            <form action="{{ url_for('handle_request', request_id=req.id, decision='accept') }}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-success btn-sm">Accept</button>
                            </form>

                            <!-- Reject button -->
                            <form action="{{ url_for('handle_request', request_id=req.id, decision='reject') }}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                            </form>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No join requests yet.</p>
        {% endif %}
    {% endif %}

    <hr>
    
    {% if current_user.is_authenticated and current_user.user_email == post.user_email %}
    <a href="{{ url_for('posts') }}" class="btn btn-secondary">Back to Activity Post</a>
    <a href="{{ url_for('edit_post', post_id=post.post_id) }}" class="btn btn-warning">Edit</a>
    {% endif %}
    <button class="btn btn-info chat-btn">Chat with Me</button>
</div>
{% endblock %}
