{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        {% set owner_email = post.email %}
        <a href="{{ url_for('post_detail', post_id=post.post_id, partner_email=owner_email) }}" class="back-btn">
            Chat with {{ header_name }}
        </a>
    </div>

    <div id="chat" data-room="{{ room }}" data-username="{{ username }}" data-postid="{{ post.post_id }}" data-partner="{{ partner_email }}">

        <ul id="messages" class="messages">
            {% set my_email = current_email|lower %}
            {% for msg in messages %}
                {% if msg.sender_email|lower == my_email %}
                    <li class="me">{{ msg.text }}</li>
                {% else %}
                    <li class="other">{{ msg.sender_name }}: {{ msg.text }}</li>
                {% endif %}
            {% endfor %}
        </ul>

        <div id="send-form">
            <input type="text" id="msg" placeholder="Type a message..." autocomplete="off">
            <button type="submit" id="send-btn" class="btn">Send</button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    const socket = io();
    const chatEl = document.getElementById('chat');
    const ROOM = chatEl.dataset.room;
    const USERNAME = chatEl.dataset.username;
    const POST_ID = chatEl.dataset.postid;
    const PARTNER = chatEl.dataset.partner;

    const inputEl = document.getElementById('msg');
    const messagesEl = document.getElementById('messages');
    const sendBtn = document.getElementById('send-btn')

    function scrollToBottom() {
        messagesEl.lastElementChild?.scrollIntoView({block:'end'});
    }

    socket.on('connect', () => {
        socket.emit('join',{ room:ROOM });
        scrollToBottom();
    });

    socket.on('message', (data) => {
        let user, text;
        if(typeof data === 'string') {
            user = 'system';
            text = data;
        } else {
            user = data.user;
            text = (user === USERNAME) ? data.text: `${data.user}: ${data.text}`;
        }

        const li = document.createElement('li');
        li.textContent = text;
        if (user === 'system') li.classList.add('system');
        else if (user === USERNAME) li.classList.add('me');
        else li.classList.add('other');

        messagesEl.appendChild(li);
        scrollToBottom();
    });

    function sendCurrentMessage() {
        const text = (inputEl.value || '').trim();
        if(!text) return;
        socket.emit('send_message', { room:ROOM, message:text, post_id:POST_ID, partner_email:PARTNER});
        inputEl.value = "";
        inputEl.focus();
    }

    sendBtn.addEventListener('click', sendCurrentMessage);

    inputEl.addEventListener('keydown', function(e) {
        if(e.key === 'Enter') {
            e.preventDefault();
            sendCurrentMessage();
        }
    });
</script>
{% endblock %}
