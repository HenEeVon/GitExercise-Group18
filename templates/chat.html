{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <h2>Chat with {{ owner_name }}</h2>

    <div id="chat" data-room="{{ room }}" data-username="{{ username }}" data-postid="{{ post.post_id }}" data-partner="{{ partner_email }}">

        <ul id="messages" class="messages">
            {% for msg in messages %}
                <li>{{ msg.sender_name }}: {{ msg.text }}</li>
            {% endfor %}
        </ul>

        <form id="send-form">
            <input type="text" id="msg" placeholder="Type a message..." autocomplete="off">
            <button type="submit" class="btn">Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    const socket = io();
    const chatEl = document.getElementById('chat');
    const ROOM = chatEl.dataset.room;
    const USERNAME = chatEl.dataset.username;
    const POST_ID = chatEl.dataset.postid;
    const PARTNER = chatEl.dataset.partner;

    socket.on('connect', function() {
        socket.emit('join',{ room:ROOM });
        console.log('Joined room:', ROOM);
    });

    socket.on('message', function(data) {
        let line;
        if(typeof data === 'string') line = data;
        else if (data && data.user && data.text) line = data.user + ': '+ data.text;
        else line = JSON.stringify(data);

        const li = document.createElement('li');
        li.textContent = line;
        document.getElementById('messages').appendChild(li);
        li.scrollIntoView({ block: "end" });
});

    document.getElementById('send-form').addEventListener('submit', function
    (e) {
        e.preventDefault();
        const input = document.getElementById('msg');
        const text = (input.value || '').trim();
        if(!text) return;
        socket.emit('send_message', { room:ROOM, message:text, post_id:POST_ID, partner_email:PARTNER});
    input.value = "";
    input.focus();
});
</script>
{% endblock %}